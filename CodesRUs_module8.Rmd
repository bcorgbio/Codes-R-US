---
title: "Project 8"
author: "CodesRUS"
date: "11/25/2021"
output:
  pdf_document: default
  html_document: default
bibliography: BIOL3140.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction
The forces produced by the tissues in our body are controlled by two main factors: speed and length. While both are equally important, in this project we aim to explore exactly what effect length can have on the force generated by a certain muscle and how fatiguing the muscle can play a role in this. A recent study by (@brughelli2010effects) was able to determine that with eccentric muscle exercise (fatiguing), there was greater extension in our muscles. This study can be analyzed further when we consider that the maximal isometric force of a sarcomere in our muscle is directly related to the degree of actin-myosin overlap. This is not only important from a physiological standpoint as we hope to better understand our muscles, it can provide important information about the longevity and success of athletes. 
	While the mechanical advantage equation is useful in estimating the output of force in your palm, there are other factors to consider. The force produced by the input is variable depending on the insertion angle. In our experiment, we are using the human upper limb, a 3rd order lever, as the subject. Data of the force outputted by the human in both control and fatigued phases was collected at 12 different angles allowing us to analyze the force-length relationship.

## Methods
We analyzed force-length relationship byâ€¦.
1. Producing isometric force-angle curves for the human forearm and flexors undertaking maximum voluntary contractions 
2. Comparing the angle at which maximum isometric force occurs between non-fatigued and eccentrically fatigued forearm flexors
3. Discussing the underlying mechanisms resulting in a shift of theta max after eccentric fatigue 

We first created a ganiometer so that we could measure the angle between our upper and lower arms when collecting our data. After collecting the data we aimed to analyze the force-length relationship in two main ways. Firstly, we produced isometric force-angle curves for the human forearm and flexors undertaking maximum voluntary contractions. Secondly, we compared the angle at which the maximum isometric force occurred between the non-fatigued and the eccentrically fatigued forearm flexors. To do this we started by determining the maximum force for each recording and normalizing them against the controlled and fatigued data. 

## Results

```{r, include=FALSE}
library(tidyverse)
library(MuMIn)
library(ggplot2)
library(dplyr)
```


```{r, "loading data and creating proper data set", echo=TRUE, results=FALSE, message=FALSE}
ang <- seq(45,157.5,length.out = 11)

k <- list.files(pattern = "control|fatigue")

print(k)
k.l <- list()
for(i in k){
  met.dat <- unlist(strsplit(i,"_"))
  sub <- met.dat[2]
  ang <- as.numeric(met.dat[3])
  exp <- gsub("\\..+","",met.dat[4])
  k.l[[i]] <- read_delim(i,delim = " ", col_names = c("Reading","Force","Unit"), id="Experiment") %>%
    mutate(sub=sub,ang=ang,exp=exp)
}
  
```

[cpk] Here's your issue, the columns don't match. Have a look at the code in the discussion related to this. 
```{r message=FALSE, "data organization and clean up", echo=TRUE, include=FALSE, results=FALSE}
data <- do.call(rbind, k.l)

data <- data%>%
  group_by(sub,exp,ang)%>%
  summarise(max.force=max(abs(Force), na.rm=TRUE), n=n())

data <- na.omit(data)
#print(data)

data.max <- data%>%
  group_by(exp)%>%
  summarize(max.f2 = max(max.force))
#print(data.max)

data.joined <- data%>%
  left_join(data.max)%>%
  mutate(norm.force=max.force/max.f2)
```

```{r, "finding the angle with maximum force"}
angle <- seq(45, 157.5, length.out=11)

data.joined %>%
  ggplot(aes(ang, norm.force))+geom_point()+geom_point(aes(x=ang[which.max(norm.force)], y=norm.force[which.max(norm.force)]), col="red", size=4)+facet_wrap(~exp, ncol=5)

data.joined$ang[which.max(data.joined$norm.force)]
```
```{r}
normf.fat <- filter(data.joined, exp=="fatigue")
normf.con <- filter(data.joined, exp=="control")

poly.m2.fat <- lm(norm.force~poly(ang,2), normf.fat)
poly.m3.fat <- lm(norm.force~poly(ang,3), normf.fat)
poly.m4.fat <- lm(norm.force~poly(ang,4), normf.fat)

AICc(poly.m2.fat, poly.m3.fat, poly.m4.fat)
#second order
poly.m2.con <- lm(norm.force~poly(ang,2), normf.con)
poly.m3.con <- lm(norm.force~poly(ang,3), normf.con)
poly.m4.con <- lm(norm.force~poly(ang,4), normf.con)

AICc(poly.m2.con, poly.m3.con, poly.m4.con)
##second order
```

```{r}

poly.con<-group_by(normf.con,sub)%>%
  summarize(
    m2=AICc(lm(norm.force~poly(ang,2))),
    m3=AICc(lm(norm.force~poly(ang,3))),
    m4=AICc(lm(norm.force~poly(ang,4)))
  )%>%
  pivot_longer(m2:m4,names_to="model",values_to="poly.con")


poly.fat<-group_by(normf.fat,sub)%>%
  summarize(
    m2=AICc(lm(norm.force~poly(ang,2))),
    m3=AICc(lm(norm.force~poly(ang,3))),
    m4=AICc(lm(norm.force~poly(ang,4)))
  )%>%
  pivot_longer(m2:m4,names_to="model",values_to="poly.fat")

```

```{r include=FALSE}
x.pred <- seq(45, 157.5, length.out=1000)

fits.con<-data.joined%>%
  group_by(sub)%>%
  summarize(
    m2=predict(lm(norm.force~poly(ang,2)),newdata=data.frame(ang=x.pred)),
    m3=predict(lm(norm.force~poly(ang,3)),newdata=data.frame(ang=x.pred)),
    m4=predict(lm(norm.force~poly(ang,4)),newdata=data.frame(ang=x.pred))
  )%>%
  pivot_longer(m2:m4,names_to="model")%>%
  group_by(sub,model)%>%
  summarize(theta_max=x.pred[which.max(value)])

fits.fat<-data.joined%>%
  group_by(sub)%>%
  summarize(
    m2=predict(lm(norm.force~poly(ang,2)),newdata=data.frame(ang=x.pred)),
    m3=predict(lm(norm.force~poly(ang,3)),newdata=data.frame(ang=x.pred)),
    m4=predict(lm(norm.force~poly(ang,4)),newdata=data.frame(ang=x.pred))
  )%>%
  pivot_longer(m2:m4,names_to="model")%>%
  group_by(sub,model)%>%
  summarize(theta_max=x.pred[which.max(value)])

best.models.con<-fits.con%>%
  left_join(poly.con)%>%
  group_by(sub)%>%
  mutate(best=poly.con==min(poly.con))%>%
  filter(best==TRUE)%>%
  select(-best)

best.models.fat<-fits.fat%>%
  left_join(poly.fat)%>%
  group_by(sub)%>%
  mutate(best=poly.fat==min(poly.fat))%>%
  filter(best==TRUE)%>%
  select(-best)

```

```{r}

best.models.con<-best.models.con%>%
  mutate(exp="control")
best.models.fat<-best.models.fat%>%
  mutate(exp="fatigue")

colnames(best.models.con)[4]="AICs"
colnames(best.models.fat)[4]="AICs"
best.models<-rbind(best.models.con,best.models.fat)

anova(lm(theta_max~exp,best.models))

```


```{r}

best.models%>%
  pivot_wider(id_cols=sub,names_from = exp,values_from=theta_max)%>%
  mutate(shift=fatigue-control)%>%
  ungroup()%>%
  summarize(mean.shift=abs(mean(na.rm=TRUE,shift)),se.shift=sd(na.rm=TRUE,shift)/sqrt(length(shift)))

?mean()
            
```






```{r}
normf.pred.con <- predict(poly.m2.con, newdata=data.frame(ang=x.pred))

normf.pred.fat <- predict(poly.m2.fat, newdata=data.frame(ang=x.pred))

sss<- data_frame(ang=x.pred,norm.force=normf.pred.con)

normf.con%>%
  ggplot(aes(ang,norm.force))+geom_point()+geom_point(data = sss, aes(x=x.pred, y=norm.force), col="red") + geom_point(data= sss, aes(x=x.pred[which.max(norm.force)], y=norm.force[which.max(norm.force)]), size=5, col="blue")


normf.fat%>%
  ggplot(aes(ang,norm.force))+geom_point()+geom_point(data = sss, aes(x=x.pred, y=norm.force), col="red") + geom_point(data= sss, aes(x=x.pred[which.max(norm.force)], y=norm.force[which.max(norm.force)]), size=5, col="blue")


```



## Discussion
After calculating the difference between control best model and fatigue best model,we find the mean shift of the max angle is 1.9 degree and standard error shift is 1.06. Our result follow the result of Yeoung's study that there is force-length relationship shifts soon after eccentric fatigue.Even though the shift after the eccentric fatigue is not very big,but this still demonstrate the influence of eccentric fatigue on force length relationship of muscle.In the bigger picture,our muscle fatigue not only change the force-length relationship but also play important role to improve the condition of chronic obstructive pulmonary disease patients. After high-intensity exercise training program,patients experiencing muscle fatigue have higher Chronic Respiratory Disease Questionnaire score and increase in 6-min walk distance. Patients who develop muscle fatigue shows better health outcome and physical capacity(@burtin2012effectiveness).Beside  physical health and longevity and athlets, the muscle fatigue can also improve the health condition for patients with certain disease.


## Contributions
Amanda Napoli:
Nick Graziano:
Zhiyuan(Tony) Wang:
Haoran(Steven) Zeng:data collection,device assembly,R coding,project write-up


## References
