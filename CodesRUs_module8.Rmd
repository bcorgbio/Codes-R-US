---
title: "Project 8"
author: "CodesRUS"
date: "11/25/2021"
output:
  html_document: default
  pdf_document: default
bibliography: BIOL3140.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction
The forces produced by the tissues in our body are controlled by two main factors: speed and length. While both are equally important, in this project we aim to explore exactly what effect length can have on the force generated by a certain muscle and how fatiguing the muscle can play a role in this. A recent study by (@brughelli2010effects) was able to determine that with eccentric muscle exercise (fatiguing), there was greater extension in our muscles. This study can be analyzed further when we consider that the maximal isometric force of a sarcomere in our muscle is directly related to the degree of actin-myosin overlap. This is not only important from a physiological standpoint as we hope to better understand our muscles, it can provide important information about the longevity and success of athletes. 
	While the mechanical advantage equation is useful in estimating the output of force in your palm, there are other factors to consider. The force produced by the input is variable depending on the insertion angle. In our experiment, we are using the human upper limb, a 3rd order lever, as the subject. Data of the force outputted by the human in both control and fatigued phases was collected at 12 different angles allowing us to analyze the force-length relationship.

## Methods
We first created a ganiometer so that we could measure the angle between our upper and lower arms when collecting our data. After collecting the data we aimed to analyze the force-length relationship in two main ways. Firstly, we produced isometric force-angle curves for the human forearm and flexors undertaking maximum voluntary contractions. Secondly, we compared the angle at which the maximum isometric force occurred between the non-fatigued and the eccentrically fatigued forearm flexors. To do this we started by determining the maximum force for each recording and normalizing them against the controlled and fatigued data. Using these normalized values, we observed any shifts that occurred in maximum force in relation to the angle. Understanding this data, we were then able to find the differences in maximum force between control and fatigued experiments. Finally, the mean shift between the experiments were calculated.

## Results

```{r, include=FALSE}
library(tidyverse)
library(MuMIn)
library(ggplot2)
library(dplyr)
```


```{r, "loading data and creating proper data set", echo=TRUE, results=FALSE, message=FALSE}
ang <- seq(45,157.5,length.out = 11)

k <- list.files("./Project8Data", full.names = T)

print(k)
k.l <- list()
for(i in k){
  met.dat <- unlist(strsplit(i,"_"))
  sub <- met.dat[2]
  ang <- as.numeric(met.dat[3])
  exp <- gsub("\\..+","",met.dat[4])
  k.l[[i]] <- read_delim(i,delim = " ", col_names = c("Reading","Force","Unit"), id="Experiment") %>%
    mutate(sub=sub,ang=ang,exp=exp)
}
  
```


```{r, "data organization and clean up", echo=TRUE, include=FALSE, results=FALSE, message=FALSE}
data <- do.call(rbind, k.l)

data <- data%>%
  group_by(sub,exp,ang)%>%
  summarise(max.force=max(abs(Force), na.rm=TRUE), n=n())

data <- na.omit(data)
#print(data)

data.max <- data%>%
  group_by(exp)%>%
  summarize(max.f2 = max(max.force))
#print(data.max)

data.joined <- data%>%
  left_join(data.max)%>%
  mutate(norm.force=max.force/max.f2)
```

```{r, "finding the angle with maximum force", fig.cap="Graphical Model Depicting Angle Values (x-axis) vs. Normal Force Values (y-axis) From Our Data Set", message=FALSE, warning=FALSE}
angle <- seq(45, 157.5, length.out=11)

data.joined %>%
  ggplot(aes(ang, norm.force))+geom_point()+geom_point(aes(x=ang[which.max(norm.force)], y=norm.force[which.max(norm.force)]), col="red", size=4)+facet_wrap(~exp, ncol=5)

data.joined$ang[which.max(data.joined$norm.force)]
```

The plot above depicts both angle measurements and their associated normalized force values throughout both experiments. Our results show that the the angle with maximum force (using the normalized force values) was 112.5 degrees (red dots on the graph). 

```{r, "constructing polynomial models and running AICc tests", message=FALSE, warning=FALSE}
normf.fat <- filter(data.joined, exp=="fatigue")
normf.con <- filter(data.joined, exp=="control")

poly.m2.fat <- lm(norm.force~poly(ang,2), normf.fat)
poly.m3.fat <- lm(norm.force~poly(ang,3), normf.fat)
poly.m4.fat <- lm(norm.force~poly(ang,4), normf.fat)

AICc(poly.m2.fat, poly.m3.fat, poly.m4.fat)
#second order
poly.m2.con <- lm(norm.force~poly(ang,2), normf.con)
poly.m3.con <- lm(norm.force~poly(ang,3), normf.con)
poly.m4.con <- lm(norm.force~poly(ang,4), normf.con)

AICc(poly.m2.con, poly.m3.con, poly.m4.con)
##second order
```
Following our plots, we filtered the data and created two new data sets with which we could individually analyze. The analyses above included creating 3 different polynomial models for each experiment type with the 2nd, 3rd, and 4th orders. Following these polynomial models, we constructed AICc models to discover the lowest AICc score. Throughout these analyses, we discovered that the second order was the best fit for both control and fatigued data.

```{r, "using the polynomial models and AICc scores to create different data sets", message=FALSE, warning=FALSE}

poly.con<-group_by(normf.con,sub)%>%
  summarize(
    m2=AICc(lm(norm.force~poly(ang,2))),
    m3=AICc(lm(norm.force~poly(ang,3))),
    m4=AICc(lm(norm.force~poly(ang,4)))
  )%>%
  pivot_longer(m2:m4,names_to="model",values_to="poly.con")


poly.fat<-group_by(normf.fat,sub)%>%
  summarize(
    m2=AICc(lm(norm.force~poly(ang,2))),
    m3=AICc(lm(norm.force~poly(ang,3))),
    m4=AICc(lm(norm.force~poly(ang,4)))
  )%>%
  pivot_longer(m2:m4,names_to="model",values_to="poly.fat")

```


```{r, "constructing tables with predicted values for 1000 discrete angles across our angle range", messsage=FALSE, warning=FALSE, include=FALSE}
x.pred <- seq(45, 157.5, length.out=1000)

fits.con<-data.joined%>%
  group_by(sub)%>%
  summarize(
    m2=predict(lm(norm.force~poly(ang,2)),newdata=data.frame(ang=x.pred)),
    m3=predict(lm(norm.force~poly(ang,3)),newdata=data.frame(ang=x.pred)),
    m4=predict(lm(norm.force~poly(ang,4)),newdata=data.frame(ang=x.pred))
  )%>%
  pivot_longer(m2:m4,names_to="model")%>%
  group_by(sub,model)%>%
  summarize(theta_max=x.pred[which.max(value)])

fits.fat<-data.joined%>%
  group_by(sub)%>%
  summarize(
    m2=predict(lm(norm.force~poly(ang,2)),newdata=data.frame(ang=x.pred)),
    m3=predict(lm(norm.force~poly(ang,3)),newdata=data.frame(ang=x.pred)),
    m4=predict(lm(norm.force~poly(ang,4)),newdata=data.frame(ang=x.pred))
  )%>%
  pivot_longer(m2:m4,names_to="model")%>%
  group_by(sub,model)%>%
  summarize(theta_max=x.pred[which.max(value)])

best.models.con<-fits.con%>%
  left_join(poly.con)%>%
  group_by(sub)%>%
  mutate(best=poly.con==min(poly.con))%>%
  filter(best==TRUE)%>%
  select(-best)

best.models.fat<-fits.fat%>%
  left_join(poly.fat)%>%
  group_by(sub)%>%
  mutate(best=poly.fat==min(poly.fat))%>%
  filter(best==TRUE)%>%
  select(-best)

```

```{r, "investigating whether a shift in theta max values occurred between the experiment types", message=FALSE, warning=FALSE}

best.models.con<-best.models.con%>%
  mutate(exp="control")
best.models.fat<-best.models.fat%>%
  mutate(exp="fatigue")

colnames(best.models.con)[4]="AICs"
colnames(best.models.fat)[4]="AICs"
best.models<-rbind(best.models.con,best.models.fat)

anova(lm(theta_max~exp,best.models))

```

Following our polynomial model constructions and AICc tests, respective data sets were created. In order to best understand and analyze this data, a following table was made which included predicted values for 1000 discrete angles throughout our given range. To discover whether a shift in theta max occurred between the different types of experiments an ANOVA test was run.
```{r, "calculating the mean shift using SEM",message=FALSE, warning=FALSE}

best.models%>%
  pivot_wider(id_cols=sub,names_from = exp,values_from=theta_max)%>%
  mutate(shift=fatigue-control)%>%
  ungroup()%>%
  summarize(mean.shift=abs(mean(na.rm=TRUE,shift)),se.shift=sd(na.rm=TRUE,shift)/sqrt(length(shift)))

?mean()
            
```

Finally, by running a final analysis with our new data sets, the mean shift value between the control and fatigued experiments was discovered - 2.37 degrees.


```{r, "plotting normalized force values against angle measurements", fig.cap="Linear Models Depicting Angle Measurements (x-axis) vs. Normalized Force Values of the Data Sets (First Graph Control; Second Fatigued)", message=FALSE, warning=FALSE}
normf.pred.con <- predict(poly.m2.con, newdata=data.frame(ang=x.pred))

normf.pred.fat <- predict(poly.m2.fat, newdata=data.frame(ang=x.pred))

sss<- data_frame(ang=x.pred,norm.force=normf.pred.con)

normf.con%>%
  ggplot(aes(ang,norm.force))+geom_point()+geom_point(data = sss, aes(x=x.pred, y=norm.force), col="red") + geom_point(data= sss, aes(x=x.pred[which.max(norm.force)], y=norm.force[which.max(norm.force)]), size=5, col="blue")


normf.fat%>%
  ggplot(aes(ang,norm.force))+geom_point()+geom_point(data = sss, aes(x=x.pred, y=norm.force), col="red") + geom_point(data= sss, aes(x=x.pred[which.max(norm.force)], y=norm.force[which.max(norm.force)]), size=5, col="blue")


```



## Discussion
After calculating the difference between control best model and fatigue best model,we find the mean shift of the max angle is 2.37 degrees and standard error shift is 1.34. Our result follow the result of Yeoung's study that there is force-length relationship shifts soon after eccentric fatigue. Even though the shift after the eccentric fatigue is not very big, this still demonstrates the influence eccentric fatigue has on force-length relationship of muscle. Looking at the bigger picture, our muscle fatigue not only changes the force-length relationship but also plays an important role in improving the condition of chronic obstructive pulmonary disease patients. After a high-intensity exercise training program, patients experiencing muscle fatigue had higher Chronic Respiratory Disease Questionnaire score and an increase in 6-min walking distance. Patients who developed muscle fatigue showed better health outcomes and physical capacities (@burtin2012effectiveness). Besides an improvement in physical health and longevity in athletes, muscle fatigue can also improve the health condition for patients with certain diseases.


## Contributions

For this project, all team members collected their own data individually and published it to the class drive. Beyond data collection, Steven worked on device assembly, R-coding and the discussion write-up. Nick worked on the Introduction, Results, and Methods sections. Tony helped with problem solving during the coding process. Amanda helped with the coding portion of the project along with the Results and References sections. Amanda and Steven worked on data analysis. All team members carried out editing at the end.


## References
